# üí∏ –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/donate 5`
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è –¥–∏–∞–ª–æ–≥ —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚úÖ Confirm / ‚ùå Cancel
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚úÖ Confirm
- –í–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ ‚úÖ Thank you!
- –ö–Ω–æ–ø–∫–∏ –∏—Å—á–µ–∑–∞—é—Ç
- **–ü–†–û–ë–õ–ï–ú–ê:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ö–æ–¥–∏—Ç –≤ –¥—Ä—É–≥–æ–π –∫–∞–Ω–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è - –∫–Ω–æ–ø–∫–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å! üò±

## –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?

**Towns –∫—ç—à–∏—Ä—É–µ—Ç UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- Towns –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç confirmation dialog –≤ –≤–∏–¥–µ —Ñ–æ—Ä–º—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç success —Å–æ–æ–±—â–µ–Ω–∏–µ
- **–ù–û:** Towns —Ö—Ä–∞–Ω–∏—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –∫—ç—à–µ
- –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –∫–∞–Ω–∞–ª ‚Üí Towns –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç UI –∏–∑ –∫—ç—à–∞
- –ö–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–Ω–æ–≤–∞! üîÑ

## –†–µ—à–µ–Ω–∏–µ

–ú—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ **–º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∑–∞—â–∏—Ç—É –æ—Ç –¥–≤–æ–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

### 1Ô∏è‚É£ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ë–î

**–¢–∞–±–ª–∏—Ü–∞:** `pending_transactions`

```sql
CREATE TABLE pending_transactions (
    id VARCHAR(100) PRIMARY KEY,
    space_id VARCHAR(100) NOT NULL,
    type VARCHAR(20) NOT NULL,
    user_id VARCHAR(66) NOT NULL,
    data JSONB NOT NULL,
    message_id VARCHAR(100),      -- ‚ú® ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏
    channel_id VARCHAR(100),      -- ‚ú® ID –∫–∞–Ω–∞–ª–∞
    status VARCHAR(20) DEFAULT 'pending',  -- ‚ú® –ù–û–í–û–ï: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    created_at TIMESTAMP DEFAULT NOW()
);
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**
- `pending` - –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- `processed` - —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
- `failed` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π

**–í handlers.ts:**

```typescript
// –ü–æ–ª—É—á–∞–µ–º pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
const pendingTx = await getPendingTransaction(originalRequestId)
if (!pendingTx) {
    console.log('[Transaction Response] No pending transaction found')
    return
}

// ‚ú® –ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞?
if (pendingTx.status === 'processed') {
    console.log('[Transaction Response] Transaction already processed')
    return  // üõë –ò–ì–ù–û–†–ò–†–£–ï–ú –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å!
}
```

### 3Ô∏è‚É£ –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞

**–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

```typescript
// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
await updatePendingTransactionStatus(originalRequestId, 'processed')

// –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã (cleanup)
await deletePendingTransaction(originalRequestId)
```

### 4Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–ö–∞–∂–¥—ã–π —á–∞—Å:**

```typescript
setInterval(async () => {
    console.log('[Cleanup] Running cleanup of old pending transactions...')
    await cleanupOldTransactions()
}, 60 * 60 * 1000)
```

**SQL:**

```sql
DELETE FROM pending_transactions 
WHERE created_at < NOW() - INTERVAL '1 hour'
```

## üéØ –ö–∞–∫ —ç—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç?

### –°—Ü–µ–Ω–∞—Ä–∏–π: –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚úÖ Confirm
   ‚Üí –û—Ç–ø—Ä–∞–≤–ª—è–µ–º transaction request
   ‚Üí –°—Ç–∞—Ç—É—Å: 'pending'
   ‚Üì

2. –°–µ—Ç—å –∑–∞–¥–µ—Ä–∂–∞–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –µ—â—ë —Ä–∞–∑
   ‚Üí –í—Ç–æ—Ä–æ–π transaction request –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
   ‚Üì

3. –ü–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç
   ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º: status == 'pending'? ‚úÖ –î–ê
   ‚Üí –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ‚úÖ
   ‚Üí –ú–µ–Ω—è–µ–º status –Ω–∞ 'processed'
   ‚Üì

4. –í—Ç–æ—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç
   ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º: status == 'processed'? ‚úÖ –î–ê
   ‚Üí –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ‚ùå (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç /donate 5
   ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
   ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (status='pending')
   ‚Üì

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç ‚úÖ Confirm
   ‚Üí –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
   ‚Üí –°—Ç–∞—Ç—É—Å ‚Üí 'processed'
   ‚Üí –£–¥–∞–ª—è–µ–º –∏–∑ –ë–î
   ‚Üì

3. Towns –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç UI –∏–∑ –∫—ç—à–∞
   ‚Üí –ö–Ω–æ–ø–∫–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è
   ‚Üí –ù–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–º—ë—Ç...
   ‚Üì

4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ë–î: –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–∞—è pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è?
   ‚Üí –ù–µ—Ç! –û–Ω–∞ —É–¥–∞–ª–µ–Ω–∞ ‚úÖ
   ‚Üí –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
   ‚Üí –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç ‚úÖ
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –ë–î

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:**

```bash
psql -U postgres -d tipsobot

SELECT id, status, type, user_id, created_at 
FROM pending_transactions 
WHERE status = 'pending'
ORDER BY created_at DESC;
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ (–±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã —á–µ—Ä–µ–∑ —á–∞—Å):**

```bash
SELECT id, status, created_at 
FROM pending_transactions 
WHERE status = 'processed'
ORDER BY created_at DESC
LIMIT 10;
```

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–æ–¥–µ?

### 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∏–∞–ª–æ–≥–∞

**src/index.ts:**

```typescript
// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∏–∞–ª–æ–≥
const sentMessage = await handler.sendInteractionRequest(...)

// –°–æ—Ö—Ä–∞–Ω—è–µ–º pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
await savePendingTransaction(
    spaceId,
    requestId,        // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    'donate',         // —Ç–∏–ø
    userId,           // –∫—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç
    data,             // –¥–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    sentMessage?.id,  // ID —Å–æ–æ–±—â–µ–Ω–∏—è
    channelId         // ID –∫–∞–Ω–∞–ª–∞
)
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

**src/handlers.ts:**

```typescript
export async function handleTransactionResponse(
    handler: BotHandler,
    event: any,
    getEthPrice: () => Promise<number>
) {
    // –ü–æ–ª—É—á–∞–µ–º pending —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    const pendingTx = await getPendingTransaction(originalRequestId)
    
    // ‚ú® –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    if (pendingTx.status === 'processed') {
        return  // üõë –£–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...
    // ...
    
    // –ú–∞—Ä–∫–∏—Ä—É–µ–º –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞
    await updatePendingTransactionStatus(originalRequestId, 'processed')
    await deletePendingTransaction(originalRequestId)
}
```

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞

**src/index.ts:**

```typescript
setInterval(async () => {
    console.log('[Cleanup] Running cleanup...')
    await cleanupOldTransactions()  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
}, 60 * 60 * 1000)  // –ö–∞–∂–¥—ã–π —á–∞—Å
```

## üìà –≠–≤–æ–ª—é—Ü–∏—è –∑–∞—â–∏—Ç—ã

| –í–µ—Ä—Å–∏—è | –ó–∞—â–∏—Ç–∞ | –ü—Ä–æ–±–ª–µ–º–∞ |
|--------|--------|----------|
| v1 | –ü—Ä–æ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ | –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Üí –¥–≤–æ–π–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ |
| v2 | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î | –ö—ç—à Towns ‚Üí –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è |
| v3 (–¢–µ–∫—É—â–∞—è) | **–°—Ç–∞—Ç—É—Å + –æ—á–∏—Å—Ç–∫–∞** | ‚úÖ **–ü–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞** |

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Üí –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
‚úÖ –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª ‚Üí –°—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ ‚Üí –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
‚úÖ Timeout ‚Üí –û—á–∏—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —á–∞—Å
‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Üí –ù–∏–∫–∞–∫–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

---

**–î–∞—Ç–∞:** 2025-12-09
**–í–µ—Ä—Å–∏—è:** 1.0
**–°—Ç–∞—Ç—É—Å:** Production Ready ‚úÖ
