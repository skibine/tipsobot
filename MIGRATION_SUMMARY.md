# TipsoBot Per-Town Statistics Migration ğŸ™ï¸\n\n## Summary\n\nThe TipsoBot has been successfully updated to support **per-town/per-space statistics**. This means each town now maintains its own independent leaderboards, statistics, and data.\n\n## What Changed\n\n### 1. **Database Schema** (`src/schema.sql`)\n- âœ… Added `space_id` to `global_stats` table\n  - Changed from single global row to per-space tracking\n  - Primary key now: `(space_id)`\n\n- âœ… Added `space_id` to `user_stats` table\n  - Primary key now: `(space_id, user_id)` - composite key\n  - Each user's stats are tracked separately per town\n\n- âœ… Added `space_id` to `payment_requests` table\n  - Tracks crowdfunding requests per town\n\n- âœ… Added `space_id` to `user_cooldowns` table\n  - Primary key now: `(space_id, user_id, command)`\n  - Cooldowns are per-town per-user\n\n- âœ… Added `space_id` to `pending_transactions` table\n  - Tracks pending operations per town\n\n- âœ… Updated indexes for optimal query performance\n  - Added composite indexes on `(space_id, ...)`\n\n### 2. **Database Functions** (`src/db.ts`)\n\nAll functions now accept `spaceId` as the first parameter:\n\n**Global Statistics:**\n- âœ… `getGlobalStats(spaceId)` - Get town-specific stats\n- âœ… `updateGlobalStats(spaceId, stats)` - Update town stats\n\n**User Statistics:**\n- âœ… `getUserStats(spaceId, userId)` - Get per-town user stats\n- âœ… `upsertUserStats(spaceId, userId, displayName, stats)` - Update per-town user stats\n\n**Leaderboards:**\n- âœ… `getTopTippers(spaceId, limit)` - Town-specific top tippers\n- âœ… `getTopDonators(spaceId, limit)` - Town-specific top donators\n\n**Cooldowns:**\n- âœ… `checkCooldown(spaceId, userId, command, cooldownMs)` - Per-town cooldown check\n- âœ… `updateCooldown(spaceId, userId, command)` - Per-town cooldown update\n- âœ… `getRemainingCooldown(spaceId, userId, command, cooldownMs)` - Per-town cooldown remaining\n\n**Pending Transactions:**\n- âœ… `savePendingTransaction(spaceId, id, type, userId, data)` - Save per-town pending tx\n\n### 3. **Main Bot Logic** (`src/index.ts`)\n\nAll commands now extract and use `spaceId` from the event:\n\n**Tipping Commands:**\n- âœ… `/tip` - Uses `event.spaceId` for stats\n- âœ… `/tipsplit` - Uses `event.spaceId` for stats\n- âœ… `/donate` - Uses `event.spaceId` for stats\n\n**Statistics Commands:**\n- âœ… `/stats` - Shows town-specific statistics\n- âœ… `/leaderboard` - Shows town-specific top contributors\n\n**Crowdfunding Commands:**\n- âœ… `/request` - Creates per-town payment requests with `spaceId` cooldown\n- âœ… `/contribute` - Contributes to per-town requests\n\n### 4. **Event Handlers** (`src/handlers.ts`)\n\n**Transaction Response Handler:**\n- âœ… Extracts `spaceId` from `event.spaceId`\n- âœ… Passes `spaceId` to all `updateGlobalStats()` calls\n- âœ… Passes `spaceId` to all `upsertUserStats()` calls\n- âœ… Ensures stats are updated only for the relevant town\n\n## How It Works\n\n### Before (Global Stats)\n```\nAll Towns â†’ Single global_stats row\n           â†’ Single user_stats table\n           â†’ Global leaderboard\n```\n\n### After (Per-Town Stats)\n```\nTown A â†’ space_id: \"0xaaa...\" â†’ Dedicated row in global_stats\n                                â†’ User stats filtered by space_id\n                                â†’ Town A leaderboard only\n\nTown B â†’ space_id: \"0xbbb...\" â†’ Separate row in global_stats\n                                â†’ User stats filtered by space_id\n                                â†’ Town B leaderboard only\n\nTown C â†’ space_id: \"0xccc...\" â†’ Isolated data\n                                â†’ No interference from other towns\n```\n\n## User Impact\n\n### `/stats` Command\n**Before:** Showed global statistics across all towns\n**After:** Shows statistics for only the town where command was used\n\n### `/leaderboard` Command\n**Before:** Global top 5 tippers/donators from all towns\n**After:** Top 5 tippers/donators from the current town only\n\n### `/request` Cooldown\n**Before:** Cooldown shared across all towns\n**After:** Cooldown per-town (can create 1 request per town per 24h)\n\n## Example Scenario\n\n```\nMoscow Town (space_id: 0xmoscow123)\n  ğŸ¥‡ Alice: $500\n  ğŸ¥ˆ Bob: $300\n  ğŸ¥‰ Charlie: $200\n  Total: $1,000\n\nBerlin Town (space_id: 0xberlin456)\n  ğŸ¥‡ David: $1,000\n  ğŸ¥ˆ Eva: $800\n  ğŸ¥‰ Frank: $600\n  Total: $2,400\n\nWhen someone in Moscow runs `/leaderboard`:\n  â†’ Sees ONLY Moscow leaders (Alice, Bob, Charlie)\n  â†’ Doesn't see Berlin's top tippers\n\nWhen someone in Berlin runs `/stats`:\n  â†’ Sees ONLY Berlin statistics\n  â†’ Doesn't see Moscow's data\n```\n\n## Migration Notes\n\nâš ï¸ **Important:** If you have existing data from before this migration, you may need to:\n\n1. **Backup your database** before deploying\n2. **Run the new schema** - it will create new tables with space_id\n3. **Existing data** will remain but won't be queryable without space_id\n4. **New operations** automatically use space_id\n\n## Testing Checklist\n\n- [ ] Deploy schema changes\n- [ ] Test `/stats` in Town A (should show Town A stats)\n- [ ] Test `/stats` in Town B (should show Town B stats)\n- [ ] Test `/leaderboard` in Town A (should show Town A leaders)\n- [ ] Test `/leaderboard` in Town B (should show Town B leaders)\n- [ ] Test `/request` cooldown per-town\n- [ ] Test `/tip` updates correct town stats\n- [ ] Verify no cross-town data leakage\n\n## Commits\n\n1. **bfd81b7** - feat: Add space_id to support per-town statistics\n2. **6ecb909** - feat: Update database functions to support per-town statistics\n3. **237aff1** - feat: Update commands to use per-town statistics (part 1)\n4. **3a8b665** - feat: Update all remaining commands to use per-town statistics\n5. **0b6fb3c** - feat: Update handlers to use spaceId for per-town statistics\n\n## Questions?\n\nEach town now has complete data isolation. The bot is now ready to scale to hundreds of towns without mixing their statistics! ğŸš€\n"